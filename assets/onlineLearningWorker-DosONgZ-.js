!function(){"use strict";class t{weights;bias;learningRate;regularization;samplesProcessed;correctPredictions;recentPredictions;latencies;lastTrainedAt;version;numClasses=3;featureCount;constructor(t=55,s=.01,e=.001){this.featureCount=t;const i=Math.sqrt(2/t);this.weights=Array(this.numClasses).fill(null).map(()=>Array(t).fill(0).map(()=>(Math.random()-.5)*i)),this.bias=Array(this.numClasses).fill(0),this.learningRate=s,this.regularization=e,this.samplesProcessed=0,this.correctPredictions=0,this.recentPredictions=[],this.latencies=[],this.lastTrainedAt=new Date,this.version=2}softmax(t){const s=Math.max(...t),e=t.map(t=>Math.exp(t-s)),i=e.reduce((t,s)=>t+s,0);return e.map(t=>t/i)}computeLogits(t){const s=[];for(let e=0;e<this.numClasses;e++){let i=this.bias[e];for(let s=0;s<t.length&&s<this.weights[e].length;s++)i+=this.weights[e][s]*t[s];s.push(i)}return s}predict(t){const s=performance.now(),e=this.computeLogits(t),i=this.softmax(e),r=i[2]-i[0],h=i.indexOf(Math.max(...i)),a=["SHORT","HOLD","LONG"][h],n=i[h],c=performance.now()-s;return this.latencies.push(c),this.latencies.length>100&&this.latencies.shift(),{probability:r,direction:a,confidence:n,probabilities:i}}train(t,s){const e=performance.now(),i=this.computeLogits(t),r=this.softmax(i),h=-Math.log(Math.max(1e-15,r[s]));for(let c=0;c<this.numClasses;c++){const e=c===s?1:0,i=r[c]-e;for(let s=0;s<this.weights[c].length&&s<t.length;s++){const e=i*t[s]+this.regularization*this.weights[c][s];this.weights[c][s]-=this.learningRate*e}this.bias[c]-=this.learningRate*i}this.samplesProcessed++;const a=r.indexOf(Math.max(...r))===s;a&&this.correctPredictions++,this.recentPredictions.push(a),this.recentPredictions.length>100&&this.recentPredictions.shift(),this.lastTrainedAt=new Date,this.version++;const n=performance.now()-e;return this.latencies.push(n),this.latencies.length>100&&this.latencies.shift(),{loss:h}}trainBatch(t){let s=0;for(const e of t){const{loss:t}=this.train(e.features,e.label);s+=t}return{totalLoss:s,avgLoss:s/t.length}}exportWeights(){return{modelType:"sgd",numClasses:this.numClasses,weights:this.weights.map(t=>[...t]),bias:[...this.bias],featureCount:this.featureCount,samplesProcessed:this.samplesProcessed,lastUpdated:this.lastTrainedAt.toISOString(),version:this.version}}importWeights(t){if(Array.isArray(t.weights[0]))this.weights=t.weights.map(t=>[...t]),this.bias=[...t.bias];else{const s=t.weights,e=t.bias;this.weights=[s.map(t=>-t),s.map(()=>0),[...s]],this.bias=[-e,0,e]}this.samplesProcessed=t.samplesProcessed||0,this.version=t.version||2}getMetrics(){const t=this.recentPredictions.filter(t=>t).length,s=this.latencies.length>0?this.latencies.reduce((t,s)=>t+s,0)/this.latencies.length:0;return{accuracy:this.samplesProcessed>0?this.correctPredictions/this.samplesProcessed:0,recentAccuracy:this.recentPredictions.length>0?t/this.recentPredictions.length:0,samplesProcessed:this.samplesProcessed,correctPredictions:this.correctPredictions,avgLatencyMs:s,lastTrainedAt:this.lastTrainedAt.toISOString(),updatesPerMinute:this.samplesProcessed}}reset(){const t=Math.sqrt(2/this.featureCount);this.weights=Array(this.numClasses).fill(null).map(()=>Array(this.featureCount).fill(0).map(()=>(Math.random()-.5)*t)),this.bias=Array(this.numClasses).fill(0),this.samplesProcessed=0,this.correctPredictions=0,this.recentPredictions=[],this.version=2}}class s{weights;bias;C;samplesProcessed;correctPredictions;recentPredictions;latencies;lastTrainedAt;version;numClasses=3;featureCount;constructor(t=55,s=1){this.featureCount=t,this.weights=Array(this.numClasses).fill(null).map(()=>Array(t).fill(0)),this.bias=Array(this.numClasses).fill(0),this.C=s,this.samplesProcessed=0,this.correctPredictions=0,this.recentPredictions=[],this.latencies=[],this.lastTrainedAt=new Date,this.version=2}scores(t){const s=[];for(let e=0;e<this.numClasses;e++){let i=this.bias[e];for(let s=0;s<t.length&&s<this.weights[e].length;s++)i+=this.weights[e][s]*t[s];s.push(i)}return s}softmax(t){const s=Math.max(...t),e=t.map(t=>Math.exp(t-s)),i=e.reduce((t,s)=>t+s,0);return e.map(t=>t/i)}predict(t){const s=performance.now(),e=this.scores(t),i=this.softmax(e),r=i[2]-i[0],h=i.indexOf(Math.max(...i)),a=performance.now()-s;return this.latencies.push(a),this.latencies.length>100&&this.latencies.shift(),{probability:r,direction:["SHORT","HOLD","LONG"][h],confidence:i[h],probabilities:i}}train(t,s){const e=performance.now(),i=this.scores(t),r=i.indexOf(Math.max(...i)),h=Math.max(0,1-i[s]+i[r]);if(r!==s&&h>0){const e=2*t.reduce((t,s)=>t+s*s,0)+2,i=Math.min(this.C,h/e);for(let r=0;r<this.weights[s].length&&r<t.length;r++)this.weights[s][r]+=i*t[r];this.bias[s]+=i;for(let s=0;s<this.weights[r].length&&s<t.length;s++)this.weights[r][s]-=i*t[s];this.bias[r]-=i}this.samplesProcessed++,r===s&&this.correctPredictions++,this.recentPredictions.push(r===s),this.recentPredictions.length>100&&this.recentPredictions.shift(),this.lastTrainedAt=new Date,this.version++;const a=performance.now()-e;return this.latencies.push(a),this.latencies.length>100&&this.latencies.shift(),{loss:h}}trainBatch(t){let s=0;for(const e of t){const{loss:t}=this.train(e.features,e.label);s+=t}return{totalLoss:s,avgLoss:s/t.length}}exportWeights(){return{modelType:"passive-aggressive",numClasses:this.numClasses,weights:this.weights.map(t=>[...t]),bias:[...this.bias],featureCount:this.featureCount,samplesProcessed:this.samplesProcessed,lastUpdated:this.lastTrainedAt.toISOString(),version:this.version}}importWeights(t){if(Array.isArray(t.weights[0]))this.weights=t.weights.map(t=>[...t]),this.bias=[...t.bias];else{const s=t.weights,e=t.bias;this.weights=[s.map(t=>-t),s.map(()=>0),[...s]],this.bias=[-e,0,e]}this.samplesProcessed=t.samplesProcessed||0,this.version=t.version||2}getMetrics(){const t=this.recentPredictions.filter(t=>t).length,s=this.latencies.length>0?this.latencies.reduce((t,s)=>t+s,0)/this.latencies.length:0;return{accuracy:this.samplesProcessed>0?this.correctPredictions/this.samplesProcessed:0,recentAccuracy:this.recentPredictions.length>0?t/this.recentPredictions.length:0,samplesProcessed:this.samplesProcessed,correctPredictions:this.correctPredictions,avgLatencyMs:s,lastTrainedAt:this.lastTrainedAt.toISOString(),updatesPerMinute:this.samplesProcessed}}reset(){this.weights=Array(this.numClasses).fill(null).map(()=>Array(this.featureCount).fill(0)),this.bias=Array(this.numClasses).fill(0),this.samplesProcessed=0,this.correctPredictions=0,this.recentPredictions=[],this.version=2}}let e=null,i=null,r="sgd";!function(r=55){e=new t(r,.01,.001),i=new s(r,1)}(55),self.onmessage=function(t){const{type:s,...h}=t.data;try{switch(s){case"train":{const t=performance.now(),{features:s,label:r}=h,a=e.train(s,r);i.train(s,r);const n={type:"training_complete",samplesProcessed:e.getMetrics().samplesProcessed,currentLoss:a.loss,latencyMs:performance.now()-t};self.postMessage(n);break}case"batch_train":{const t=performance.now(),{samples:s}=h,r=e.trainBatch(s);i.trainBatch(s);const a={type:"training_complete",samplesProcessed:e.getMetrics().samplesProcessed,currentLoss:r.avgLoss,latencyMs:performance.now()-t};self.postMessage(a);break}case"predict":{const t=performance.now(),{features:s}=h,a={type:"prediction",...("sgd"===r?e:i).predict(s),latencyMs:performance.now()-t};self.postMessage(a);break}case"predict_all":{const t=performance.now(),{features:s}=h,r={type:"prediction_all",sgd:e.predict(s),passiveAggressive:i.predict(s),latencyMs:performance.now()-t};self.postMessage(r);break}case"export":{const t={type:"export",weights:{sgd:e.exportWeights(),passiveAggressive:i.exportWeights()}};self.postMessage(t);break}case"import":{const{weights:t}=h;t.sgd&&e.importWeights(t.sgd),t.passiveAggressive&&i.importWeights(t.passiveAggressive),self.postMessage({type:"import_complete"});break}case"get_metrics":{const t={type:"metrics",metrics:{sgd:e.getMetrics(),passiveAggressive:i.getMetrics()}};self.postMessage(t);break}case"reset":e.reset(),i.reset(),self.postMessage({type:"reset_complete"});break;case"set_model":r=h.modelType,self.postMessage({type:"model_set",modelType:r});break;default:self.postMessage({type:"error",message:`Unknown message type: ${s}`})}}catch(a){self.postMessage({type:"error",message:a instanceof Error?a.message:"Unknown error"})}},self.postMessage({type:"ready"})}();
